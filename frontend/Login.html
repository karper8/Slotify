<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Slotting Tool</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
</head>
<body>
  <!-- ✅ Navbar -->
  <nav class="navbar">
    <a href="Home.html">Home</a>
    <a href="Login.html" style="color: #ffd700;">Account</a>
    <a href="AboutUs.html">About Us</a>
    <a href="upload_page.html">Upload</a>
    <button class="theme-toggle" onclick="toggleTheme()">
      <i class="fas fa-moon"></i>
    </button>
  </nav>

  <!-- ✅ Login Form -->
  <main class="form-container">
    <h1>Login</h1>
    <form id="loginForm">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required placeholder="Enter your email">

      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required placeholder="Enter your password">

      <button type="submit" class="button" id="loginButton">
        <span id="loginButtonText">Login</span>
        <span id="loginButtonSpinner" style="display: none;">
          <i class="fas fa-spinner fa-spin"></i>
        </span>
      </button>
    </form>
    <p>Don't have an account? <a href="Signup.html">Sign up here</a></p>
    <div id="loginStatus" class="status-message"></div>
  </main>

  <footer class="footer">
    <p>&copy; 2025 Slotting Tool. All rights reserved.</p>
  </footer>

  <script>
    AOS.init();

    // ✅ Theme Toggle Script
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }

    // Enhanced Login form handling
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const statusElement = document.getElementById('loginStatus');
      const loginButton = document.getElementById('loginButton');
      const loginButtonText = document.getElementById('loginButtonText');
      const loginButtonSpinner = document.getElementById('loginButtonSpinner');
      
      // Input validation
      if (!email || !password) {
        showStatus('Please fill in all fields', 'error');
        return;
      }
      
      if (!isValidEmail(email)) {
        showStatus('Please enter a valid email address', 'error');
        return;
      }
      
      // Show loading state
      setLoadingState(true);
      showStatus('Logging in...', 'info');
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: email, // Using email as username
            password: password
          }),
          credentials: 'include'
        });

        const result = await response.json();
        
        if (response.ok) {
          showStatus('Login successful! Redirecting...', 'success');
          
          // Store user info in localStorage for future use
          localStorage.setItem('user', JSON.stringify({
            username: email,
            loggedIn: true,
            loginTime: new Date().toISOString()
          }));
          
          // Redirect to upload page after successful login
          setTimeout(() => {
            window.location.href = 'upload_page.html';
          }, 1500);
        } else {
          showStatus(result.error || 'Login failed. Please check your credentials.', 'error');
        }
      } catch (error) {
        console.error('Login error:', error);
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          showStatus('Cannot connect to server. Please check if the backend is running.', 'error');
        } else {
          showStatus('Network error. Please try again.', 'error');
        }
      } finally {
        setLoadingState(false);
      }
    });

    // Helper functions
    function showStatus(message, type) {
      const statusElement = document.getElementById('loginStatus');
      statusElement.textContent = message;
      statusElement.className = `status-message ${type}`;
      
      // Auto-hide error messages after 5 seconds
      if (type === 'error') {
        setTimeout(() => {
          statusElement.textContent = '';
          statusElement.className = 'status-message';
        }, 5000);
      }
    }

    function setLoadingState(isLoading) {
      const loginButton = document.getElementById('loginButton');
      const loginButtonText = document.getElementById('loginButtonText');
      const loginButtonSpinner = document.getElementById('loginButtonSpinner');
      
      if (isLoading) {
        loginButton.disabled = true;
        loginButtonText.style.display = 'none';
        loginButtonSpinner.style.display = 'inline-block';
      } else {
        loginButton.disabled = false;
        loginButtonText.style.display = 'inline-block';
        loginButtonSpinner.style.display = 'none';
      }
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

        // ✅ Preserve Theme on Page Reload and Check Session
        window.addEventListener('load', function() {
            // Load theme first
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
            }
            
            // Then check if user is already logged in
            const user = localStorage.getItem('user');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    if (userData.loggedIn) {
                        console.log('User already logged in, redirecting to upload page');
                        showStatus('You are already logged in. Redirecting...', 'info');
                        setTimeout(() => {
                            window.location.href = 'upload_page.html';
                        }, 1500);
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    localStorage.removeItem('user');
                }
            }
        });
  </script>
</body>
</html>